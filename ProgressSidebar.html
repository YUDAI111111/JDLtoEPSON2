<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:14px; }
    .row{ margin: 8px 0; }
    .bar{ width:100%; height:10px; background:#eee; border-radius:6px; overflow:hidden; }
    .fill{ height:100%; width:0%; background:#4caf50; transition: width .25s linear; }
    .kpi{ font-size:12px; color:#555; display:flex; flex-direction:column; gap:6px; }
    .kpi b{ color:#222; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .btn{
      display:inline-block; padding:8px 12px; border-radius:8px; border:1px solid #ccc;
      background:#fff; cursor:pointer; user-select:none;
    }
    .btn[disabled]{
      opacity:.45; cursor:not-allowed; pointer-events:none;
    }
  </style>
</head>
<body>
  <h2 style="margin:0 0 10px 0;">変換 進行状況</h2>
  <div class="row bar"><div id="fill" class="fill"></div></div>

  <div class="row kpi mono">
    <div>進捗: <b><span id="pct">0</span>%</b></div>
    <div>件数: <b><span id="done">0</span>/<span id="total">0</span></b></div>
    <div>残り目安: <b><span id="eta">--</span></b></div>
    <div>マッピング不足 D:<b id="mapD">0</b> / C:<b id="mapC">0</b></div>
    <div>税区分 未知 D:<b id="taxD">0</b> / C:<b id="taxC">0</b></div>
  </div>

  <div class="row">
    <button id="dl" class="btn" disabled>CSVをダウンロード</button>
    <span id="note" class="mono" style="font-size:12px; color:#666; margin-left:8px;"></span>
  </div>

  <script>
    let generating = false;

    function fmtSec(s){
      if(!s || s<=0) return '--';
      const m = Math.floor(s/60), sec = s%60;
      return m ? (m+'分'+sec+'秒') : (sec+'秒');
    }

    function setEnabled(can){
      const btn = document.getElementById('dl');
      if (can && !generating) btn.removeAttribute('disabled');
      else btn.setAttribute('disabled','disabled');
    }

    function render(snap){
      if(!snap) return;
      document.getElementById('pct').textContent   = snap.percent||0;
      document.getElementById('done').textContent  = snap.done||0;
      document.getElementById('total').textContent = snap.total||0;
      document.getElementById('eta').textContent   = fmtSec(snap.etaSec||0);
      document.getElementById('mapD').textContent  = (snap.err && snap.err.mapD)||0;
      document.getElementById('mapC').textContent  = (snap.err && snap.err.mapC)||0;
      document.getElementById('taxD').textContent  = (snap.err && snap.err.taxD)||0;
      document.getElementById('taxC').textContent  = (snap.err && snap.err.taxC)||0;
      document.getElementById('fill').style.width  = Math.max(0, Math.min(100, snap.percent||0)) + '%';

      const noError = ((snap.err?.mapD||0)+(snap.err?.mapC||0)+(snap.err?.taxD||0)+(snap.err?.taxC||0))===0;
      const ready   = (snap.percent===100) && noError && !!snap.canExport;
      setEnabled(ready);
      document.getElementById('note').textContent = ready ? '' : '※100%かつエラーなしで有効化';
    }

    function poll(){
      google.script.run.withSuccessHandler(render).getProgressSnapshot();
    }
    poll();
    setInterval(poll, 800);

    document.getElementById('dl').addEventListener('click', function(){
      if (generating) return;
      generating = true; setEnabled(false);
      const btn = document.getElementById('dl');
      const old = btn.textContent;
      btn.textContent = 'CSV生成中…';

      google.script.run.withSuccessHandler(function(res){
        // res = { filename, base64, mime }
        try{
          const a = document.createElement('a');
          a.href = 'data:'+(res.mime||'text/csv')+';base64,' + res.base64;
          a.download = res.filename || 'converted.csv';
          document.body.appendChild(a);
          a.click();
          a.remove();
        }finally{
          generating = false;
          btn.textContent = old;
          poll();
        }
      }).buildConvertedCsvBase64();
    });
  </script>
</body>
</html>
